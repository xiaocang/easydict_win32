name: ARM64 MSIX Smoke Test

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: 1

jobs:
  arm64-msix-smoke:
    name: Build + Launch MSIX (ARM64)
    runs-on: [self-hosted, Windows, ARM64, win11-arm64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: dotnet/global.json

      - name: Setup WinApp CLI
        uses: microsoft/setup-WinAppCli@v0.1

      - name: Restore WinUI project (arm64)
        working-directory: dotnet
        shell: pwsh
        run: |
          dotnet restore src/Easydict.WinUI/Easydict.WinUI.csproj --runtime win-arm64

      - name: Publish WinUI App for MSIX (arm64)
        working-directory: dotnet
        shell: pwsh
        run: |
          dotnet publish src/Easydict.WinUI/Easydict.WinUI.csproj `
            --configuration Release `
            --runtime win-arm64 `
            --self-contained true `
            --no-restore `
            --output ./publish-msix/arm64 `
            -p:Platform=arm64 `
            -p:PublishTrimmed=false `
            -p:WindowsAppSDKSelfContained=false

      - name: Publish NativeBridge (arm64)
        working-directory: dotnet
        shell: pwsh
        run: |
          dotnet publish src/Easydict.NativeBridge/Easydict.NativeBridge.csproj `
            --configuration Release `
            --runtime win-arm64 `
            --self-contained true `
            --output ./publish-msix/arm64 `
            -p:PublishTrimmed=true

      - name: Publish BrowserRegistrar (arm64)
        working-directory: dotnet
        shell: pwsh
        run: |
          dotnet publish src/Easydict.BrowserRegistrar/Easydict.BrowserRegistrar.csproj `
            --configuration Release `
            --runtime win-arm64 `
            --self-contained true `
            --output ./publish-msix/arm64 `
            -p:PublishTrimmed=true

      - name: Fix resources.pri for MSIX
        shell: pwsh
        run: |
          $publishDir = "dotnet/publish-msix/arm64"
          $sourcePri = Join-Path $publishDir "Easydict.WinUI.pri"
          $targetPri = Join-Path $publishDir "resources.pri"

          if (Test-Path $sourcePri) {
            Copy-Item -Path $sourcePri -Destination $targetPri -Force
            Write-Host "Copied Easydict.WinUI.pri -> resources.pri"
          } elseif (Test-Path $targetPri) {
            Write-Host "resources.pri already exists"
          } else {
            Write-Error "No PRI file found in publish output"
            exit 1
          }

      - name: Create ARM64 MSIX package
        working-directory: dotnet
        shell: pwsh
        run: |
          $manifestPath = "src/Easydict.WinUI/Package.appxmanifest"
          $tempManifest = Join-Path $env:RUNNER_TEMP "Package.arm64.appxmanifest"

          $content = Get-Content $manifestPath -Raw
          $content = $content -replace 'ProcessorArchitecture="[^"]*"', 'ProcessorArchitecture="arm64"'
          Set-Content $tempManifest $content -Encoding utf8

          New-Item -ItemType Directory -Force -Path ./msix | Out-Null
          winapp package `
            ./publish-msix/arm64 `
            --output ./msix/Easydict-arm64-smoke.msix `
            --manifest $tempManifest `
            --skip-pri `
            --verbose

      - name: Fix MSIX MinVersion
        shell: pwsh
        run: |
          dotnet/scripts/Fix-MsixMinVersion.ps1 -MsixPath "dotnet/msix/Easydict-arm64-smoke.msix"

      - name: Enable Developer Mode (sideloading)
        shell: pwsh
        run: |
          reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\AppModelUnlock" `
            /t REG_DWORD /v AllowDevelopmentWithoutDevLicense /d 1 /f

      - name: Install Windows App Runtime (arm64)
        shell: pwsh
        run: |
          $url = "https://aka.ms/windowsappsdk/1.8/latest/windowsappruntimeinstall-arm64.exe"
          $installer = Join-Path $env:TEMP "windowsappruntimeinstall-arm64.exe"
          Invoke-WebRequest -Uri $url -OutFile $installer
          Start-Process -FilePath $installer -ArgumentList "--quiet","--force" -Wait -NoNewWindow
          Write-Host "Windows App Runtime arm64 installed"

      - name: Install MSIX package (register from extracted layout)
        shell: pwsh
        run: |
          $msixPath = "dotnet/msix/Easydict-arm64-smoke.msix"
          $extractDir = "dotnet/msix/extracted-arm64"

          if (Test-Path $extractDir) {
            Remove-Item $extractDir -Recurse -Force
          }
          Expand-Archive -Path $msixPath -DestinationPath $extractDir -Force

          $manifest = Join-Path $extractDir "AppxManifest.xml"
          Add-AppxPackage -Register $manifest -DisableDevelopmentMode

      - name: Launch app and verify main window appears
        shell: pwsh
        run: |
          $package = Get-AppxPackage -Name "xiaocang.EasydictforWindows" -ErrorAction SilentlyContinue
          if (-not $package) {
            Write-Error "Package not installed"
            exit 1
          }

          $appId = "shell:AppsFolder\$($package.PackageFamilyName)!App"
          Start-Process "explorer.exe" $appId
          Write-Host "Launched: $appId"

          $deadline = (Get-Date).AddSeconds(60)
          $windowFound = $false

          while ((Get-Date) -lt $deadline) {
            $uiProcs = Get-Process -Name "Easydict.WinUI" -ErrorAction SilentlyContinue
            if ($uiProcs) {
              foreach ($proc in $uiProcs) {
                if ($proc.MainWindowHandle -ne 0) {
                  Write-Host "Main window detected. PID=$($proc.Id), Title=$($proc.MainWindowTitle)"
                  $windowFound = $true
                  break
                }
              }
            }

            if ($windowFound) { break }
            Start-Sleep -Seconds 2
          }

          if (-not $windowFound) {
            Write-Error "App did not show a main window within timeout"
            Get-Process -Name "Easydict.WinUI" -ErrorAction SilentlyContinue | Format-Table Id, ProcessName, MainWindowTitle
            exit 1
          }

      - name: Upload MSIX artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: easydict-arm64-smoke-msix
          path: dotnet/msix/Easydict-arm64-smoke.msix
