name: Performance Benchmarks

on:
  push:
    branches: [master]
    paths:
      - 'dotnet/src/Easydict.WinUI/Services/MouseHookService.cs'
      - 'dotnet/src/Easydict.WinUI/Services/PopButtonService.cs'
      - 'dotnet/src/Easydict.WinUI/Services/TextSelectionService.cs'
      - 'dotnet/src/Easydict.WinUI/Views/PopButtonWindow.xaml.cs'
      - 'dotnet/tests/Easydict.WinUI.Tests/Services/SelectionPerformanceTests.cs'
      - 'dotnet/src/Easydict.WinUI/Services/SettingsService.cs'
      - 'dotnet/src/Easydict.WinUI/Services/TranslationManagerService.cs'
      - 'dotnet/src/Easydict.TranslationService/TranslationManager.cs'
      - 'dotnet/tests/Easydict.TranslationService.Tests/StartupPerformanceTests.cs'
  pull_request:
    branches: [master]
    paths:
      - 'dotnet/src/Easydict.WinUI/Services/MouseHookService.cs'
      - 'dotnet/src/Easydict.WinUI/Services/PopButtonService.cs'
      - 'dotnet/src/Easydict.WinUI/Services/TextSelectionService.cs'
      - 'dotnet/src/Easydict.WinUI/Views/PopButtonWindow.xaml.cs'
      - 'dotnet/tests/Easydict.WinUI.Tests/Services/SelectionPerformanceTests.cs'
      - 'dotnet/src/Easydict.WinUI/Services/SettingsService.cs'
      - 'dotnet/src/Easydict.WinUI/Services/TranslationManagerService.cs'
      - 'dotnet/src/Easydict.TranslationService/TranslationManager.cs'
      - 'dotnet/tests/Easydict.TranslationService.Tests/StartupPerformanceTests.cs'
  workflow_dispatch:

jobs:
  benchmark:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: dotnet/global.json

      - name: Restore dependencies
        working-directory: dotnet
        run: dotnet restore Easydict.Win32.sln -p:Platform=x64

      - name: Build (Release)
        working-directory: dotnet
        # WindowsAppSdkAutoInitialize=false prevents the SDK from generating a module
        # constructor that tries to initialize the Windows App SDK runtime. Without this,
        # loading the Easydict.WinUI assembly on CI (which lacks the SDK runtime) throws
        # TypeInitializationException before any test can run.
        run: dotnet build tests/Easydict.WinUI.Tests/Easydict.WinUI.Tests.csproj -c Release -p:Platform=x64 -p:WindowsAppSdkAutoInitialize=false

      - name: Run performance benchmarks
        working-directory: dotnet
        run: >-
          dotnet test tests/Easydict.WinUI.Tests/Easydict.WinUI.Tests.csproj
          --no-build
          -c Release
          -p:Platform=x64
          --filter "Category=Performance"
          --verbosity normal
          --logger "trx;LogFileName=benchmark-results.trx"
          --logger "console;verbosity=detailed"

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-results
          path: dotnet/**/TestResults/benchmark-results.trx

  startup-benchmark:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: dotnet/global.json

      - name: Restore dependencies
        working-directory: dotnet
        run: dotnet restore tests/Easydict.TranslationService.Tests/Easydict.TranslationService.Tests.csproj

      - name: Build (Release)
        working-directory: dotnet
        run: dotnet build tests/Easydict.TranslationService.Tests/Easydict.TranslationService.Tests.csproj -c Release

      - name: Run startup performance benchmarks
        working-directory: dotnet
        run: >-
          dotnet test tests/Easydict.TranslationService.Tests/Easydict.TranslationService.Tests.csproj
          --no-build
          -c Release
          --filter "Category=Performance"
          --verbosity normal
          --logger "trx;LogFileName=startup-benchmark-results.trx"
          --logger "console;verbosity=detailed"

      - name: Upload startup benchmark results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: startup-benchmark-results
          path: dotnet/**/TestResults/startup-benchmark-results.trx
