name: Browser Registrar Release

# Separate release workflow for BrowserHostRegistrar.
# Triggered by vr-* tags with the same format as the main app's v-* tags:
#   - vr-X.Y.Z         (stable, e.g. vr-1.0.0)
#   - vr-X.Y.Z-suffix  (pre-release, e.g. vr-1.0.0-rc.1, vr-1.0.0-beta.1)
#
# Each run also updates the "vr-latest" release so the app can always
# download the newest registrar via a fixed URL:
#   https://github.com/<owner>/<repo>/releases/download/vr-latest/BrowserHostRegistrar-<platform>.exe
#
# Usage:
#   git tag vr-1.0.0 && git push origin vr-1.0.0

on:
  push:
    tags:
      - 'vr-*'

permissions:
  contents: write

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: 1

jobs:
  build-registrar:
    name: Build Registrar (${{ matrix.platform }})
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [x64, arm64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate tag format
        shell: bash
        run: |
          TAG="${GITHUB_REF_NAME}"

          # Must be vr- followed by semver, optionally with pre-release suffix
          if [[ ! "$TAG" =~ ^vr-[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "Error: Tag '$TAG' does not match expected format (vr-X.Y.Z or vr-X.Y.Z-suffix)"
            echo "Examples: vr-1.0.0, vr-1.0.0-rc.1, vr-1.0.0-beta.2"
            exit 1
          fi

          echo "Tag validated: $TAG"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: dotnet/global.json

      - name: Restore dependencies
        working-directory: dotnet
        run: dotnet restore src/Easydict.BrowserRegistrar/Easydict.BrowserRegistrar.csproj --runtime win-${{ matrix.platform }}

      - name: Publish BrowserHostRegistrar
        working-directory: dotnet
        run: |
          dotnet publish src/Easydict.BrowserRegistrar/Easydict.BrowserRegistrar.csproj `
            --configuration Release `
            --runtime win-${{ matrix.platform }} `
            --self-contained true `
            --no-restore `
            --output ./publish-registrar/${{ matrix.platform }} `
            -p:PublishTrimmed=true

      - name: Prepare release assets
        shell: pwsh
        run: |
          $platform = "${{ matrix.platform }}"
          $outDir = "registrar-assets"
          New-Item -ItemType Directory -Force -Path $outDir

          # Copy registrar with platform suffix
          $registrar = "dotnet/publish-registrar/$platform/BrowserHostRegistrar.exe"
          if (Test-Path $registrar) {
            Copy-Item $registrar "$outDir/BrowserHostRegistrar-$platform.exe"
            $sizeMB = [math]::Round((Get-Item $registrar).Length / 1MB, 2)
            Write-Host "Registrar ($platform): $sizeMB MB"
          } else {
            Write-Error "BrowserHostRegistrar.exe not found at $registrar"
            exit 1
          }

          # Generate SHA256 checksum
          $checksumFile = "$outDir/browser-support-$platform.sha256"
          $files = Get-ChildItem "$outDir/*.exe"
          $lines = @()
          foreach ($f in $files) {
            $hash = (Get-FileHash $f -Algorithm SHA256).Hash.ToLower()
            $lines += "$hash *$($f.Name)"
            Write-Host "$hash  $($f.Name)"
          }
          $lines | Out-File -FilePath $checksumFile -Encoding utf8
          Write-Host "Checksum written to $checksumFile"

      - name: Upload registrar assets
        uses: actions/upload-artifact@v4
        with:
          name: registrar-${{ matrix.platform }}
          path: registrar-assets/*
          retention-days: 7

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build-registrar

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all registrar artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: registrar-*
          path: release-assets
          merge-multiple: true

      - name: List release assets
        run: ls -la release-assets/

      # Create the versioned release (e.g. vr-1.0.0)
      - name: Create versioned release
        uses: softprops/action-gh-release@v1
        with:
          name: "Browser Registrar ${{ github.ref_name }}"
          body: |
            Browser Host Registrar release for Easydict browser extension support.

            This standalone tool registers the Native Messaging host outside the MSIX sandbox,
            allowing Chrome and Firefox extensions to communicate with the Easydict app.

            ## Assets
            - `BrowserHostRegistrar-x64.exe` — for x64 (Intel/AMD) systems
            - `BrowserHostRegistrar-arm64.exe` — for ARM64 systems
            - `browser-support-*.sha256` — SHA256 checksums for verification

            ## Usage
            The Easydict app downloads and runs this registrar automatically.
            Manual usage:
            ```
            BrowserHostRegistrar-x64.exe install --chrome --firefox
            BrowserHostRegistrar-x64.exe uninstall --chrome --firefox
            BrowserHostRegistrar-x64.exe status
            ```
          files: |
            release-assets/*
          generate_release_notes: false

      # Update the "vr-latest" release so the app can always download
      # from a fixed URL regardless of the versioned tag.
      - name: Update vr-latest release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Delete existing vr-latest release and tag (ignore errors if not found)
          gh release delete vr-latest --yes --cleanup-tag 2>/dev/null || true

          # Create new vr-latest release with the same assets
          gh release create vr-latest release-assets/* \
            --title "Browser Registrar (latest)" \
            --notes "Latest Browser Host Registrar build (from ${{ github.ref_name }}).

          The Easydict app downloads from this release automatically.
          This release is updated on every \`vr-*\` tag push." \
            --latest=false
