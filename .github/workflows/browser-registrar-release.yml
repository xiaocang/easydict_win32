name: Browser Registrar Release

# Separate release workflow for BrowserHostRegistrar.
# Triggered by vr-* tags (e.g. vr-1.0.0-1, vr-1.0.0-2).
# Creates a GitHub release with only the registrar exe per platform.
#
# Usage:
#   git tag vr-1.0.0-1 && git push origin vr-1.0.0-1

on:
  push:
    tags:
      - 'vr-*'

permissions:
  contents: write

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: 1

jobs:
  build-registrar:
    name: Build Registrar (${{ matrix.platform }})
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [x64, arm64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: dotnet/global.json

      - name: Restore dependencies
        working-directory: dotnet
        run: dotnet restore src/Easydict.BrowserRegistrar/Easydict.BrowserRegistrar.csproj --runtime win-${{ matrix.platform }}

      - name: Publish BrowserHostRegistrar
        working-directory: dotnet
        run: |
          dotnet publish src/Easydict.BrowserRegistrar/Easydict.BrowserRegistrar.csproj `
            --configuration Release `
            --runtime win-${{ matrix.platform }} `
            --self-contained true `
            --no-restore `
            --output ./publish-registrar/${{ matrix.platform }} `
            -p:PublishTrimmed=true

      - name: Prepare release assets
        shell: pwsh
        run: |
          $platform = "${{ matrix.platform }}"
          $outDir = "registrar-assets"
          New-Item -ItemType Directory -Force -Path $outDir

          # Copy registrar with platform suffix
          $registrar = "dotnet/publish-registrar/$platform/BrowserHostRegistrar.exe"
          if (Test-Path $registrar) {
            Copy-Item $registrar "$outDir/BrowserHostRegistrar-$platform.exe"
            $sizeMB = [math]::Round((Get-Item $registrar).Length / 1MB, 2)
            Write-Host "Registrar ($platform): $sizeMB MB"
          } else {
            Write-Error "BrowserHostRegistrar.exe not found at $registrar"
            exit 1
          }

          # Generate SHA256 checksum
          $checksumFile = "$outDir/browser-support-$platform.sha256"
          $files = Get-ChildItem "$outDir/*.exe"
          $lines = @()
          foreach ($f in $files) {
            $hash = (Get-FileHash $f -Algorithm SHA256).Hash.ToLower()
            $lines += "$hash *$($f.Name)"
            Write-Host "$hash  $($f.Name)"
          }
          $lines | Out-File -FilePath $checksumFile -Encoding utf8
          Write-Host "Checksum written to $checksumFile"

      - name: Upload registrar assets
        uses: actions/upload-artifact@v4
        with:
          name: registrar-${{ matrix.platform }}
          path: registrar-assets/*
          retention-days: 7

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build-registrar

    steps:
      - name: Download all registrar artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: registrar-*
          path: release-assets
          merge-multiple: true

      - name: List release assets
        run: ls -la release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Browser Registrar ${{ github.ref_name }}"
          body: |
            Browser Host Registrar release for Easydict browser extension support.

            This standalone tool registers the Native Messaging host outside the MSIX sandbox,
            allowing Chrome and Firefox extensions to communicate with the Easydict app.

            ## Assets
            - `BrowserHostRegistrar-x64.exe` — for x64 (Intel/AMD) systems
            - `BrowserHostRegistrar-arm64.exe` — for ARM64 systems
            - `browser-support-*.sha256` — SHA256 checksums for verification

            ## Usage
            The Easydict app downloads and runs this registrar automatically.
            Manual usage:
            ```
            BrowserHostRegistrar-x64.exe install --chrome --firefox
            BrowserHostRegistrar-x64.exe uninstall --chrome --firefox
            BrowserHostRegistrar-x64.exe status
            ```
          files: |
            release-assets/*
          generate_release_notes: false
